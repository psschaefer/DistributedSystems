apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-config
  namespace: tempconv2
  labels:
    app: tempconv2
    component: backend
data:
  envoy.yaml: |
    static_resources:
      listeners:
        - name: listener_0
          address:
            socket_address: { address: 0.0.0.0, port_value: 8080 }
          filter_chains:
            - filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    codec_type: auto
                    stat_prefix: ingress_http
                    internal_address_config:
                      cidr_ranges:
                        - address_prefix: "10.0.0.0"
                          prefix_len: 8
                        - address_prefix: "172.16.0.0"
                          prefix_len: 12
                        - address_prefix: "192.168.0.0"
                          prefix_len: 16
                        - address_prefix: "127.0.0.1"
                          prefix_len: 32
                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: local_service
                          domains: ["*"]
                          typed_per_filter_config:
                            envoy.filters.http.cors:
                              "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.CorsPolicy
                              allow_origin_string_match:
                                - prefix: "http"
                                - prefix: "https"
                              allow_methods: "GET, POST, PUT, DELETE, OPTIONS"
                              allow_headers: "content-type,x-grpc-web,x-user-agent"
                              expose_headers: "grpc-status,grpc-message"
                          routes:
                            - match: { prefix: "/grpc" }
                              route:
                                cluster: backend_grpc
                                timeout: 0s
                                prefix_rewrite: "/"
                                max_stream_duration:
                                  grpc_timeout_header_max: 0s
                            - match: { prefix: "/" }
                              route:
                                cluster: backend_grpc
                                timeout: 0s
                                max_stream_duration:
                                  grpc_timeout_header_max: 0s
                    http_filters:
                      - name: envoy.filters.http.cors
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
                      - name: envoy.filters.http.grpc_web
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
      clusters:
        - name: backend_grpc
          type: logical_dns
          lb_policy: round_robin
          typed_extension_protocol_options:
            envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
              "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
              explicit_http_config:
                http2_protocol_options: {}
          load_assignment:
            cluster_name: backend_grpc
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: 127.0.0.1
                          port_value: 9090
    admin:
      address:
        socket_address: { address: 0.0.0.0, port_value: 9901 }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: tempconv2
  labels:
    app: tempconv2
    component: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tempconv2
      component: backend
  template:
    metadata:
      labels:
        app: tempconv2
        component: backend
    spec:
      containers:
        - name: backend
          image: gcr.io/tempconv2-487514/tempconv2-backend:latest
          ports:
            - name: grpc
              containerPort: 9090
            - name: health
              containerPort: 9091
          env:
            - name: GRPC_PORT
              value: "9090"
            - name: HEALTH_PORT
              value: "9091"
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 9091
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 9091
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 3
        - name: envoy
          image: envoyproxy/envoy:v1.31-latest
          ports:
            - containerPort: 8080
          args:
            - -c
            - /etc/envoy/envoy.yaml
          volumeMounts:
            - name: envoy-config
              readOnly: true
              mountPath: /etc/envoy
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "200m"
      volumes:
        - name: envoy-config
          configMap:
            name: envoy-config
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: tempconv2
  labels:
    app: tempconv2
    component: backend
spec:
  selector:
    app: tempconv2
    component: backend
  ports:
    - name: grpc-web
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: health
      port: 9091
      targetPort: 9091
      protocol: TCP
  type: ClusterIP
